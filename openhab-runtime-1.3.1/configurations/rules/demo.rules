import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
import java.lang.*
var Integer lum = 0
var Number counter = 1
var Number counter5 = 1
var Number counter10 = 1
var Number luminosity = 0
var Number shutdown = 1
var Timer timer = null

rule Startup
when 
	System started
then
	say("Welcome at openHab!")
end

rule Goodbye
when 
	System shuts down
then
	say("Good bye!")
end

rule "Initialise luminosity"
when
	System started
then
	postUpdate(Luminosity, 50)
	postUpdate(Door_Front, CLOSED)
	postUpdate(Door_Back, CLOSED)
end

rule "Crontest"
	when 
		Time cron "0/4 * * * * ?"
	then
		luminosity = Luminosity.state as DecimalType 
		luminosity = luminosity - 1
		postUpdate(Luminosity, luminosity)
		counter = counter + 1
end

rule "Lights off"
	when
		Time cron "0 0 20 ? * MON-FRI" // every day of the week at 20:00:00
	then
		postUpdate(Automatic_Luminosity, OFF)
		sendCommand(Light_Front, OFF)
		sendCommand(Light_Back, OFF)
		shutdown = 0
		say("Lights shut down")
end

rule "Lights can be on"
	when
		Time cron "0 0 7 ? * MON-FRI" // every day of the week at 7:00:00
	then
		shutdown = 1
		say("Lights can be on")
end

rule "Lights on"
	when
		Item Door_Front received update OPEN or
		Item Door_Back received update OPEN
	then
		if (shutdown == 1) {
			shutdown = 2
			postUpdate(Automatic_Luminosity, ON)
			sendCommand(Light_Front, ON)
			sendCommand(Light_Back, ON)
			say("Lights on!")
		} else if (shutdown == 0) {
			say("ALARM!")
			sendMail("julien.fleury@ensimag.grenoble-inp.fr", "Alarm : Intrusion in classroom", "An intrusion has been seen in the classroom. Please check ")
		}
end

rule "Open Door"
	when 
		Time cron "0/4 * * * * ?"
	then
		postUpdate(Door_Front, CLOSED)
		postUpdate(Door_Back, OPEN)
end	

rule "Close Door"
	when 
		Time cron "2/4 * * * * ?"
	then
		postUpdate(Door_Front, OPEN)
		postUpdate(Door_Back, CLOSED)
end

rule "Mouvement Detection"
	when
		Item Mouvement_Detector received update
	then
		if (Mouvement_Detector.state==ON) {
			say("Mouvement!")
		}
end

rule "To much lights"
	when
		Item Luminosity received update
	then
		if (Automatic_Luminosity.state == ON) {
			if (Luminosity.state < 45) {
				postUpdate(Luminosity, 50)
				sendCommand(Light_Front, INCREASE)
				sendCommand(Light_Back, INCREASE)
			} else if (Luminosity.state > 55) {
				postUpdate(Luminosity, 50)
				sendCommand(Light_Front, DECREASE)
				sendCommand(Light_Back, DECREASE)
			}
		}
end

/**
 * This is a demo rule which simulates a real dimmer by reacting to increase/decrease commands 
 * and posting an updated state on the bus 
 */
rule "Dimmed Light Front"
	when
		Item Light_Front received command
	then
		var Number percent = 0
		if(Light_Front.state instanceof DecimalType) percent = Light_Front.state as DecimalType 
			
		if(receivedCommand==INCREASE) percent = percent + 5
		if(receivedCommand==DECREASE) percent = percent - 5

		if(percent<0)   percent = 0
		if(percent>100) percent = 100
		postUpdate(Light_Front, percent);
end
rule "Dimmed Light Back"
	when
		Item Light_Back received command
	then
		var Number percent = 0
		if(Light_Back.state instanceof DecimalType) percent = Light_Back.state as DecimalType
		
		if(receivedCommand==INCREASE) percent = percent + 5
		if(receivedCommand==DECREASE) percent = percent - 5

		if(percent<0)   percent = 0
		if(percent>100) percent = 100
		postUpdate(Light_Back, percent);
end

rule "Color Light Back"
	when
		Item Color_Light_Back received command
	then
		var HSBType hsbValue = Color_Light_Back.state as HSBType

        var Number redValue   = hsbValue.red.intValue
        var Number greenValue = hsbValue.green.intValue
        var Number blueValue  = hsbValue.blue.intValue
        
	
	
        if (redValue == 100 && greenValue == 0 && blueValue == 0) {
        	//say("Red")
        } if (redValue == 100 && greenValue == 50 && blueValue == 0) {
        	//say("Orange")
        } else if (redValue == 0 && greenValue == 100 && blueValue == 0) {
        	//say("Green")
        } else if (redValue == 0 && greenValue == 0 && blueValue == 100) {
        	//say("Blue")
        } else if (redValue == 100 && greenValue == 100 && blueValue == 100) {
        	//say("White")
        } else {
        	//say("Color")
        	//say(redValue)
        	//say(greenValue)
        	//say(blueValue)
        	sendCommand(Scene_General, 0)
        }
end
rule "Color Light Front"
	when
		Item Color_Light_Front received command
	then
		var HSBType hsbValue = Color_Light_Front.state as HSBType

        var Number redValue   = hsbValue.red.intValue
        var Number greenValue = hsbValue.green.intValue
        var Number blueValue  = hsbValue.blue.intValue
        var String res = "rgb:" + redValue + ":" + greenValue + ":" + blueValue + ":"
        sendCommand( ArduinoControllerRGB, res )
        //sendMail("julien.fleury@ensimag.grenoble-inp.fr", "Alarm : Intrusion in classroom", "An intrusion has been seen in the classroom. Please check ")
        
end

rule "Dimmed Shutter Front Up"
	when
		Item Shutter_Front received command UP
	then
		say("Front Up")
		// Todo : send a command to the motor
		
end
rule "Dimmed Shutter Front Down"
	when
		Item Shutter_Front received command DOWN
	then
		say("Front Down")
		// Todo : send a command to the motor
		
end
rule "Dimmed Shutter Back Up"
	when
		Item Shutter_Back received command UP
	then
		say("Back Up")
		// Todo : send a command to the motor
		
end
rule "Dimmed Shutter Back Down"
	when
		Item Shutter_Back received command DOWN
	then
		say("Back Down")
		// Todo : send a command to the motor
		
end

rule "Scene changing"
	when
		Item Scene_General received command
	then
		var Number scene = 0
		if(Scene_General.state instanceof DecimalType) scene = Scene_General.state as DecimalType
		
		var H = 0
		var S = 0
		var B = 0
        
		switch(scene) {
			case 0 : {
				// nothing
			}
			case 1 : {
				// White: during a course
				H = 0
				S = 0
				B = 100
			}
			case 2 : {
				// Orange/Yellow: conference
				H = 30
				S = 100
				B = 100
			}
			case 3 : {
				// Blue: before exam
				H = 240
				S = 100
				B = 100
			}
			case 4 : {
				// Green: during exam
				H = 120
				S = 100
				B = 100
			}
		}
		if (scene != 0) {
			sendCommand(Color_Light_Back, H+","+S+","+B)
			sendCommand(Color_Light_Front, H+","+S+","+B)	
		}
end

/**
 * This rule demonstrates how a NumberItem can be used to easily control the local sound system.
 * A selection widget in the UI provides easy access for this
 */
rule "Select Radio Station"
	when
		Item Radio_Station received command
	then
		switch(receivedCommand) {
			case 0 : playStream(null)
			case 1 : playStream("http://metafiles.gl-systemhaus.de/hr/hr3_2.m3u")
			case 2 : playStream("http://mp3-live.swr3.de/swr3_m.m3u")
			case 3 : playStream("http://edge.live.mp3.mdn.newmedia.nacamar.net/radioffh/livestream.mp3.m3u")
		}
end

rule turnLightOn
when Item Light_Arduino changed from ON to OFF

then 
	sendCommand(ArduinoController,"abc\r\n")
end

rule turnLightOff
when Item Light_Arduino changed from OFF to ON

then
	sendCommand(ArduinoController,"abc\r\n")
end	

rule processSerial
when Item ArduinoControllerLUM received update

then
		lum=0
		if (ArduinoControllerLUM.state.toString().substring(0,3).equals("lum")) {
			var i = 4
			while (ArduinoControllerLUM.state.toString().charAt(i) != ":".charAt(0)) {
				lum = lum * 10 + ArduinoControllerLUM.state.toString().charAt(i) - '0'.charAt(0)
				i=i+1
			}
			println("LUMINOSITY")
			println(lum)
			
		}
		
	
end

